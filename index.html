<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Multi-User Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827', /* Darker background */
                        'secondary-dark': '#1f2937', /* Card/Input background */
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                        'google-red': '#db4437'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .chat-container {
            /* Calculate height based on full screen minus header and footer/input area */
            height: calc(100vh - 8rem); 
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        /* Responsive adjustments for mobile/PC compatibility */
        #chat-app {
            max-width: 100%;
            height: 100vh;
        }
        @media (min-width: 768px) {
            #chat-app {
                max-width: 700px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex justify-center items-center">

    <div id="chat-app" class="flex flex-col bg-primary-dark shadow-2xl rounded-lg overflow-hidden w-full h-full md:h-[90vh]">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center p-8 text-center flex-grow">
            <h2 class="text-4xl font-extrabold mb-4 text-accent-blue">Secure Chat Login</h2>
            <p class="text-gray-400 mb-8 max-w-sm">Sign in with your Google account to join the conversation and identify yourself by your Gmail address.</p>
            <button id="google-sign-in-button" 
                    class="flex items-center justify-center bg-google-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl transform hover:scale-[1.03] active:scale-95">
                <!-- Google Icon SVG -->
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.5-.2-2.2H12v4.16h5.88c-.26 1.42-1.04 2.68-2.3 3.53l-2.45 2.02v3.09h3.76c2.2-2.03 3.57-5.01 3.57-8.2zm-12.72 10.15c2.94 0 5.46-1.04 7.28-2.8l-3.76-3.09c-1.04.7-2.36 1.13-3.86 1.13-2.98 0-5.5-1.9-6.36-4.49H3.7v3.08c1.78 3.51 5.38 5.97 9.08 5.97zM4.3 9.4c-.16-.5-.25-1.03-.25-1.58s.09-1.08.25-1.58V3.24H.54c-.67 1.34-1.04 2.87-1.04 4.58s.37 3.24 1.04 4.58l3.76-3.08zM12 3.86c1.82 0 3.44.62 4.74 1.84l3.29-3.29C17.46.74 14.8.0 12.0.0c-3.7 0-7.3 2.46-9.08 5.97l3.76 3.08C6.5 5.76 9.02 3.86 12 3.86z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <!-- Chat Screen -->
        <div id="chat-screen" class="hidden flex-col flex-grow">
            <!-- Header Section -->
            <header class="bg-secondary-dark p-4 shadow-xl flex justify-between items-center z-10">
                <h1 class="text-xl font-bold text-accent-green truncate">
                    Welcome, <span id="user-email-display" class="font-normal text-sm"></span>
                </h1>
                <button id="sign-out-button"
                        class="text-xs text-gray-400 hover:text-red-500 transition duration-200 p-2 rounded-lg">
                    Sign Out
                </button>
            </header>

            <!-- Chat Messages Container -->
            <main id="chat-messages" class="chat-container flex-grow p-4 space-y-4"></main>

            <!-- Footer/Input Section -->
            <footer class="bg-secondary-dark p-4 shadow-2xl z-10">
                <div id="loading-indicator" class="text-center text-accent-blue mb-2 hidden">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full" role="status"></div>
                    Loading messages...
                </div>
                <div class="flex space-x-3">
                    <input type="text" id="message-input" placeholder="Type your message..."
                           class="flex-grow p-3 rounded-xl bg-primary-dark border border-gray-700 focus:outline-none focus:ring-2 focus:ring-accent-blue text-gray-100 placeholder-gray-500 transition duration-300 shadow-inner"
                           autocomplete="off" maxlength="500" disabled>
                    <button id="send-button"
                            class="bg-accent-blue text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-600 transition duration-300 transform hover:scale-[1.02] active:scale-95 disabled:bg-gray-600 disabled:shadow-none"
                            disabled>
                        Send
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =========================================================================
        // ðŸš¨ IMPORTANT: REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL FIREBASE CONFIG ðŸš¨
        // This configuration is PUBLIC and required for Google Sign-In outside the Canvas environment.
        // =========================================================================
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyD8H7djMIWuXB8f0t37S0VwL8xm39jaWdI",
            authDomain: "dheechat-1258a.firebaseapp.com",
            projectId: "dheechat-1258a",
            databaseURL: "https://dheechat-1258a-default-rtdb.firebaseio.com",
            storageBucket: "dheechat-1258a.firebasestorage.app",
            messagingSenderId: "893019112248",
            appId: "1:893019112248:web:9d813c2339311f74f5f7cd"
        };
        // =========================================================================
        
        // --- Configuration Logic ---
        let firebaseConfig;
        let appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            // Running in Canvas environment
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        } else {
            // Running on GitHub Pages or locally
            firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId || 'chat-default-id';
            // Check if config placeholders were replaced
            if (firebaseConfig.apiKey === "AIzaSyD8H7djMIWuXB8f0t37S0VwL8xm39jaWdI") {
                console.error("WARNING: Firebase configuration placeholders not replaced. Google Sign-In will fail.");
            }
        }
        
        // --- Global Firebase Instances and User State ---
        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = null;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const userEmailDisplay = document.getElementById('user-email-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Utility Functions ---

        // Exponential backoff retry for network operations
        async function fetchWithRetry(apiCall, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function switchView(showChat) {
            loginScreen.classList.toggle('hidden', showChat);
            chatScreen.classList.toggle('hidden', !showChat);
        }

        // --- Authentication Logic ---

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                // Auth state change listener will handle view switch
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                // Display error message to the user (instead of alert)
                userEmailDisplay.textContent = 'Login Error!';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out failed:", error);
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.classList.add('hidden');
                if (user) {
                    // User is signed in
                    currentUserId = user.uid;
                    currentUserEmail = user.email;

                    userEmailDisplay.textContent = currentUserEmail || 'Signed In';
                    switchView(true); // Show chat screen

                    // Enable input controls
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                    
                    // Start listening for messages
                    listenForMessages();

                } else {
                    // User is signed out
                    currentUserId = null;
                    currentUserEmail = null;
                    switchView(false); // Show login screen
                    chatMessagesContainer.innerHTML = ''; // Clear chat history
                }
            });
        }


        // --- Message Rendering and Firestore ---

        function renderMessage(message, isMe) {
            const messageDiv = document.createElement('div');
            
            // Flexbox container for message bubble positioning
            let classes = ['flex', 'max-w-[80%]', 'md:max-w-md'];
            
            if (isMe) {
                classes.push('self-end', 'justify-end', 'ml-auto');
            } else {
                classes.push('self-start', 'justify-start', 'mr-auto');
            }

            messageDiv.className = classes.join(' ');

            // Bubble content styling
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl shadow-lg break-words transition duration-300 ${isMe 
                ? 'bg-accent-blue text-white rounded-br-none' 
                : 'bg-secondary-dark text-gray-100 rounded-tl-none'
            }`;
            
            // Username/Email
            const emailSpan = document.createElement('span');
            emailSpan.textContent = message.email || 'Anonymous';
            emailSpan.className = `block text-xs font-bold mb-1 ${isMe ? 'text-blue-200' : 'text-accent-green'}`;
            bubble.appendChild(emailSpan);
            
            // Message Text
            const textP = document.createElement('p');
            textP.textContent = message.text;
            textP.className = 'text-base';
            bubble.appendChild(textP);

            // Timestamp
            if (message.timestamp) {
                const date = new Date(message.timestamp);
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const timeSpan = document.createElement('span');
                timeSpan.textContent = time;
                timeSpan.className = `block mt-1 text-xs ${isMe ? 'text-blue-200 text-right' : 'text-gray-400 text-left'}`;
                bubble.appendChild(timeSpan);
            }

            messageDiv.appendChild(bubble);
            chatMessagesContainer.appendChild(messageDiv);
        }

        function listenForMessages() {
            // Collection path: /artifacts/{appId}/public/data/messages
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            const colRef = collection(db, messagesCollectionPath);
            
            // We fetch all documents and sort them locally by timestamp
            const messagesQuery = query(colRef);

            // Set up real-time listener
            onSnapshot(messagesQuery, (snapshot) => {
                let messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp?.toMillis ? data.timestamp.toMillis() : (data.timestamp || Date.now());
                    messages.push({ ...data, id: doc.id, timestamp });
                });

                // Sort messages locally by timestamp (Ascending)
                messages.sort((a, b) => a.timestamp - b.timestamp);

                // Check if we were at the bottom before rendering
                const shouldScroll = chatMessagesContainer.scrollHeight - chatMessagesContainer.scrollTop <= chatMessagesContainer.clientHeight + 50;

                // Clear container and re-render
                chatMessagesContainer.innerHTML = '';
                messages.forEach(message => {
                    renderMessage(message, message.userId === currentUserId);
                });
                
                // Only scroll if the user was near the bottom
                if (shouldScroll) {
                    scrollToBottom();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUserId || !currentUserEmail || !db) return;

            try {
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                
                await fetchWithRetry(async () => {
                    await addDoc(collection(db, messagesCollectionPath), {
                        userId: currentUserId,
                        email: currentUserEmail,
                        text: text,
                        timestamp: Date.now()
                    });
                });
                
                messageInput.value = '';
                // Focus input after sending
                messageInput.focus();
            } catch (error) {
                console.error("Error sending message:", error);
                // Simple feedback for the user
                const errorEl = document.createElement('div');
                errorEl.textContent = 'Failed to send message. Please try again.';
                errorEl.className = 'text-red-500 text-center p-2';
                chatMessagesContainer.appendChild(errorEl);
                scrollToBottom();
            }
        }

        // --- Initialization and Event Setup ---

        async function setupApp() {
            try {
                setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                loadingIndicator.classList.remove('hidden');

                // If running in Canvas and token is available, sign in with custom token first
                if (initialAuthToken) {
                    await fetchWithRetry(async () => {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas environment: Signed in with custom token.");
                    });
                }
                
                setupAuthListener();
            } catch (error) {
                console.error("Fatal Error during app setup:", error);
                // Hide loading and show a critical error
                loadingIndicator.classList.add('hidden');
                userEmailDisplay.textContent = 'CRITICAL ERROR: Check Console';
            }
        }

        // --- Event Listeners ---
        googleSignInButton.addEventListener('click', handleGoogleSignIn);
        signOutButton.addEventListener('click', handleSignOut);
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize App on load
        window.onload = setupApp;

    </script>
</body>
</html>


