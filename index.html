<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Multi-User Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827', /* Darker background */
                        'secondary-dark': '#1f2937', /* Card/Input background */
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                        'google-red': '#db4437'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .chat-container {
            /* Calculate height based on full screen minus header and footer/input area */
            height: calc(100vh - 8rem); 
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        /* Responsive adjustments for mobile/PC compatibility */
        #chat-app {
            max-width: 100%;
            height: 100vh;
        }
        @media (min-width: 768px) {
            #chat-app {
                max-width: 700px;
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex justify-center items-center">

    <div id="chat-app" class="flex flex-col bg-primary-dark shadow-2xl rounded-lg overflow-hidden w-full h-full md:h-[90vh]">

        <div id="login-screen" class="flex flex-col items-center justify-center p-8 text-center flex-grow">
            <h2 class="text-4xl font-extrabold mb-4 text-accent-blue">Secure Chat Login</h2>
            <p class="text-gray-400 mb-8 max-w-sm">Sign in with your Google account to join the conversation and identify yourself by your Gmail address.</p>
            <button id="google-sign-in-button" 
                    class="flex items-center justify-center bg-google-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl transform hover:scale-[1.03] active:scale-95">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.5-.2-2.2H12v4.16h5.88c-.26 1.42-1.04 2.68-2.3 3.53l-2.45 2.02v3.09h3.76c2.2-2.03 3.57-5.01 3.57-8.2zm-12.72 10.15c2.94 0 5.46-1.04 7.28-2.8l-3.76-3.09c-1.04.7-2.36 1.13-3.86 1.13-2.98 0-5.5-1.9-6.36-4.49H3.7v3.08c1.78 3.51 5.38 5.97 9.08 5.97zM4.3 9.4c-.16-.5-.25-1.03-.25-1.58s.09-1.08.25-1.58V3.24H.54c-.67 1.34-1.04 2.87-1.04 4.58s.37 3.24 1.04 4.58l3.76-3.08zM12 3.86c1.82 0 3.44.62 4.74 1.84l3.29-3.29C17.46.74 14.8.0 12.0.0c-3.7 0-7.3 2.46-9.08 5.97l3.76 3.08C6.5 5.76 9.02 3.86 12 3.86z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <div id="chat-screen" class="hidden flex-col flex-grow">
            
            <header class="bg-secondary-dark p-4 shadow-xl flex justify-between items-center z-20 relative">
                <div class="flex items-center">
                    <button id="menu-button"
                            class="p-2 rounded-full hover:bg-gray-700 transition duration-200 focus:outline-none mr-3">
                        <svg class="w-6 h-6 text-gray-100" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-accent-green truncate">
                        Public Chat
                    </h1>
                </div>
                
                <div class="flex items-center">
                    <span id="user-email-display" class="font-normal text-sm text-gray-400 mr-4 hidden md:block truncate max-w-xs"></span>
                    <button id="sign-out-button"
                            class="text-xs text-gray-400 hover:text-red-500 transition duration-200 p-2 rounded-lg">
                        Sign Out
                    </button>
                </div>
            </header>

            <div id="side-menu" 
                class="fixed inset-0 z-30 bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none md:w-full">
                
                <div class="absolute left-0 top-0 h-full w-64 bg-primary-dark shadow-2xl transform -translate-x-full transition-transform duration-300 flex flex-col">
                    <div class="p-4 bg-secondary-dark flex justify-between items-center border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-white">Menu & Contacts</h3>
                        <button id="close-menu-button" class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="p-4 border-b border-gray-700">
                        <p class="text-sm text-gray-400 mb-2">Logged in as:</p>
                        <p id="menu-user-email" class="text-white font-medium break-all"></p>
                        <button id="clear-public-chat-button"
                                class="mt-4 w-full text-center py-2 px-3 text-sm rounded-lg bg-google-red hover:bg-red-700 transition duration-200 text-white font-semibold">
                            Clear Public Chat History
                        </button>
                    </div>

                    <div class="p-4 flex-grow overflow-y-auto">
                        <h4 class="text-md font-semibold text-accent-green mb-3">Recent Contacts (P2P ready)</h4>
                        <div id="contact-list" class="space-y-2">
                            <div class="text-sm text-gray-500 p-2 border border-gray-800 rounded-lg">
                                Contacts will appear here once Private Messaging logic is added.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <main id="chat-messages" class="chat-container flex-grow p-4 space-y-4"></main>

            <footer class="bg-secondary-dark p-4 shadow-2xl z-10">
                <div id="loading-indicator" class="text-center text-accent-blue mb-2 hidden">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full" role="status"></div>
                    Loading messages...
                </div>
                <div class="flex space-x-3 items-center">
                    
                    <input type="file" id="file-input" class="hidden" accept="image/*,video/*,.pdf,.zip,.doc,.docx" />
                    
                    <button id="attach-button"
                            class="p-3 rounded-full text-gray-400 hover:text-accent-green hover:bg-gray-700 transition duration-300 disabled:opacity-50"
                            title="Attach File" disabled>
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.574 6.574A3 3 0 1010.5 17.5l6.574-6.574a4 4 0 10-5.656-5.656L4.5 13.5a5 5 0 107.071 7.071l6.574-6.574"></path>
                        </svg>
                    </button>
                    
                    <input type="text" id="message-input" placeholder="Type your message..."
                           class="flex-grow p-3 rounded-xl bg-primary-dark border border-gray-700 focus:outline-none focus:ring-2 focus:ring-accent-blue text-gray-100 placeholder-gray-500 transition duration-300 shadow-inner"
                           autocomplete="off" maxlength="500" disabled>
                    <button id="send-button"
                            class="bg-accent-blue text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-600 transition duration-300 transform hover:scale-[1.02] active:scale-95 disabled:bg-gray-600 disabled:shadow-none"
                            disabled>
                        Send
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
        // ✅ NEW: Import Firebase Storage Functions
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

        // =========================================================================
        // ✅ Your New Firebase Configuration (from dhee-chat-e14bc)
        // =========================================================================
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAwfV2UkHnFJOET4yQpxXkCItP2FmTG2g8",
            authDomain: "dhee-chat-e14bc.firebaseapp.com",
            projectId: "dhee-chat-e14bc",
            storageBucket: "dhee-chat-e14bc.firebasestorage.app",
            messagingSenderId: "1091790414441",
            appId: "1:1091790414441:web:42bfa96e6b3eea8bdff8f8",
        };
        // =========================================================================
        
        // --- Configuration Logic ---
        let firebaseConfig;
        let appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        } else {
            firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId || 'chat-default-id';
        }
        
        // --- Global Firebase Instances and User State ---
        let db;
        let auth;
        let storage; // ✅ NEW: Storage instance
        let currentUserId = null;
        let currentUserEmail = null;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const userEmailDisplay = document.getElementById('user-email-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Menu Elements ---
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuButton = document.getElementById('close-menu-button');
        const menuUserEmail = document.getElementById('menu-user-email');
        const clearPublicChatButton = document.getElementById('clear-public-chat-button');
        const contactList = document.getElementById('contact-list');
        
        // --- NEW FILE ELEMENTS ---
        const fileInput = document.getElementById('file-input');
        const attachButton = document.getElementById('attach-button');
        // -------------------------

        // --- Utility Functions ---

        async function fetchWithRetry(apiCall, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function switchView(showChat) {
            loginScreen.classList.toggle('hidden', showChat);
            chatScreen.classList.toggle('hidden', !showChat);
        }

        // --- Menu Control Functions ---
        function openMenu() {
            sideMenu.classList.remove('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.remove('-translate-x-full'); 
        }

        function closeMenu() {
            sideMenu.classList.add('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.add('-translate-x-full');
        }

        function handleMenuClick(event) {
            if (event.target === sideMenu) {
                closeMenu();
            }
        }
        // -------------------------------------

        // --- Authentication Logic ---

        // ... handleGoogleSignIn and handleSignOut remain the same ...
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                userEmailDisplay.textContent = 'Login Error! Check console & domain settings.';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out failed:", error);
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, (user) => {
                loadingIndicator.classList.add('hidden');
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;

                    userEmailDisplay.textContent = currentUserEmail || 'Signed In';
                    menuUserEmail.textContent = currentUserEmail || 'Signed In'; 
                    
                    switchView(true);

                    // Enable input controls (UPDATED to include attach button)
                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    attachButton.disabled = false; 
                    messageInput.focus();
                    
                    listenForMessages();

                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    switchView(false);
                    chatMessagesContainer.innerHTML = '';
                    closeMenu();
                }
            });
        }


        // --- Message Rendering and Firestore (UPDATED) ---

        function renderMessage(message, isMe) {
            const messageDiv = document.createElement('div');
            
            let classes = ['flex', 'max-w-[80%]', 'md:max-w-md'];
            
            if (isMe) {
                classes.push('self-end', 'justify-end', 'ml-auto');
            } else {
                classes.push('self-start', 'justify-start', 'mr-auto');
            }

            messageDiv.className = classes.join(' ');

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl shadow-lg break-words transition duration-300 ${isMe 
                ? 'bg-accent-blue text-white rounded-br-none' 
                : 'bg-secondary-dark text-gray-100 rounded-tl-none'
            }`;
            
            // Username/Email
            const emailSpan = document.createElement('span');
            emailSpan.textContent = message.email || 'Anonymous';
            emailSpan.className = `block text-xs font-bold mb-1 ${isMe ? 'text-blue-200' : 'text-accent-green'}`;
            bubble.appendChild(emailSpan);
            
            // --- Message Content (File or Text) ---
            if (message.fileURL && message.fileType) {
                // This is a file attachment
                const fileContainer = document.createElement('div');
                fileContainer.className = 'mt-2';

                // Check if it's an image
                if (message.fileType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = message.fileURL;
                    img.alt = 'Attached Image';
                    img.className = 'max-w-full h-auto rounded-lg mb-2 cursor-pointer border border-gray-700';
                    img.onclick = () => window.open(message.fileURL, '_blank'); // Open image in new tab
                    fileContainer.appendChild(img);
                } 
                // Check if it's a video
                else if (message.fileType.startsWith('video/')) {
                     const video = document.createElement('video');
                     video.src = message.fileURL;
                     video.controls = true;
                     video.className = 'max-w-full h-auto rounded-lg mb-2 border border-gray-700';
                     fileContainer.appendChild(video);
                }
                
                // For all other files (or images/videos that failed to load inline)
                const fileLink = document.createElement('a');
                fileLink.href = message.fileURL;
                fileLink.target = '_blank';
                fileLink.className = 'text-sm font-medium underline hover:text-accent-green flex items-center';
                fileLink.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.574 6.574A3 3 0 1010.5 17.5l6.574-6.574a4 4 0 10-5.656-5.656L4.5 13.5a5 5 0 107.071 7.071l6.574-6.574"></path></svg> 
                                     Download File (${message.fileType.split('/')[1] || message.fileType})`;
                
                fileContainer.appendChild(fileLink);
                bubble.appendChild(fileContainer);

                // Add optional text if available
                if (message.text) {
                    const textP = document.createElement('p');
                    textP.textContent = message.text;
                    textP.className = 'text-base mt-2';
                    bubble.appendChild(textP);
                }
            } else {
                // Standard text message
                const textP = document.createElement('p');
                textP.textContent = message.text;
                textP.className = 'text-base';
                bubble.appendChild(textP);
            }
            // ---------------------------------------

            // Timestamp
            if (message.timestamp) {
                const date = new Date(message.timestamp);
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const timeSpan = document.createElement('span');
                timeSpan.textContent = time;
                timeSpan.className = `block mt-1 text-xs ${isMe ? 'text-blue-200 text-right' : 'text-gray-400 text-left'}`;
                bubble.appendChild(timeSpan);
            }

            messageDiv.appendChild(bubble);
            chatMessagesContainer.appendChild(messageDiv);
        }

        // ... listenForMessages remains the same ...
        function listenForMessages() {
            const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            const colRef = collection(db, messagesCollectionPath);
            
            const messagesQuery = query(colRef);

            onSnapshot(messagesQuery, (snapshot) => {
                let messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp?.toMillis ? data.timestamp.toMillis() : (data.timestamp || Date.now());
                    messages.push({ ...data, id: doc.id, timestamp });
                });

                messages.sort((a, b) => a.timestamp - b.timestamp);

                const shouldScroll = chatMessagesContainer.scrollHeight - chatMessagesContainer.scrollTop <= chatMessagesContainer.clientHeight + 50;

                chatMessagesContainer.innerHTML = '';
                messages.forEach(message => {
                    renderMessage(message, message.userId === currentUserId);
                });
                
                if (shouldScroll) {
                    scrollToBottom();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
            });
        }

        // --- Message Sending Functions (UPDATED) ---

        // Original sendMessage for text only
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUserId || !currentUserEmail || !db) return;

            await postMessageToFirestore({ text: text });
            messageInput.value = '';
            messageInput.focus();
        }

        // NEW: Core function to post data to Firestore
        async function postMessageToFirestore(messageData) {
            try {
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                
                await fetchWithRetry(async () => {
                    await addDoc(collection(db, messagesCollectionPath), {
                        userId: currentUserId,
                        email: currentUserEmail,
                        timestamp: Date.now(),
                        ...messageData // Includes text, or fileURL/fileType
                    });
                });
            } catch (error) {
                console.error("Error sending message:", error);
                const errorEl = document.createElement('div');
                errorEl.textContent = 'Failed to send message. Please try again.';
                errorEl.className = 'text-red-500 text-center p-2';
                chatMessagesContainer.appendChild(errorEl);
                scrollToBottom();
            }
        }

        // NEW: File Handling
        function handleFileSelect() {
            fileInput.click();
        }

        async function uploadFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Lock controls during upload
            sendButton.disabled = true;
            attachButton.disabled = true;
            messageInput.disabled = true;
            loadingIndicator.classList.remove('hidden');

            const filePath = `chat_files/${currentUserId}/${Date.now()}_${file.name}`;
            const storageRef = ref(storage, filePath);
            const uploadTask = uploadBytesResumable(storageRef, file);
            
            try {
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', 
                        (snapshot) => {
                            // Optional: Monitor progress
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('Upload is ' + progress.toFixed(0) + '% done');
                            loadingIndicator.textContent = `Uploading file: ${progress.toFixed(0)}%`;
                        }, 
                        (error) => {
                            reject(error);
                        }, 
                        () => {
                            resolve();
                        }
                    );
                });

                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                const optionalText = messageInput.value.trim();

                // Send the URL and file metadata to Firestore
                await postMessageToFirestore({
                    text: optionalText,
                    fileURL: downloadURL,
                    fileType: file.type
                });

                messageInput.value = ''; // Clear text input
                loadingIndicator.textContent = 'Loading messages...'; // Reset indicator text
            } catch (error) {
                console.error("File upload failed:", error);
                alert("File upload failed: " + error.message);
            } finally {
                // Unlock controls
                sendButton.disabled = false;
                attachButton.disabled = false;
                messageInput.disabled = false;
                loadingIndicator.classList.add('hidden');
                fileInput.value = ''; // Reset file input
            }
        }


        // ... handleClearPublicChat remains the same ...
        async function handleClearPublicChat() {
            if (!confirm("Are you sure you want to permanently delete ALL messages from the Public Chat? This cannot be undone.")) {
                return;
            }

            try {
                const messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                const colRef = collection(db, messagesCollectionPath);
                
                const snapshot = await getDocs(query(colRef));
                
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                console.log(`Successfully deleted ${deletePromises.length} public messages.`);
                closeMenu();
                alert("Public Chat History Cleared!");

            } catch (error) {
                console.error("Error clearing public chat:", error);
                alert("Failed to clear chat. You may not have the necessary security permissions.");
            }
        }


        // --- Initialization and Event Setup ---

        async function setupApp() {
            try {
                setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                storage = getStorage(app); // ✅ NEW: Initialize Storage
                auth = getAuth(app);

                loadingIndicator.classList.remove('hidden');

                if (initialAuthToken) {
                    await fetchWithRetry(async () => {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas environment: Signed in with custom token.");
                    });
                }
                
                setupAuthListener();
            } catch (error) {
                console.error("Fatal Error during app setup:", error);
                loadingIndicator.classList.add('hidden');
                userEmailDisplay.textContent = 'CRITICAL ERROR: Check Console';
            }
        }

        // --- Event Listeners ---
        googleSignInButton.addEventListener('click', handleGoogleSignIn);
        signOutButton.addEventListener('click', handleSignOut);
        sendButton.addEventListener('click', sendMessage);
        
        // Menu Listeners
        menuButton.addEventListener('click', openMenu);
        closeMenuButton.addEventListener('click', closeMenu);
        sideMenu.addEventListener('click', handleMenuClick);
        clearPublicChatButton.addEventListener('click', handleClearPublicChat);

        // ✅ NEW File Attachment Listeners
        attachButton.addEventListener('click', handleFileSelect);
        fileInput.addEventListener('change', uploadFile);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize App on load
        window.onload = setupApp;

    </script>
</body>
</html>
