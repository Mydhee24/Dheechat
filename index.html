<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Multi-User Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827', /* Darker background */
                        'secondary-dark': '#1f2937', /* Card/Input background */
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                        'google-red': '#db4437'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* General scrollbar styling */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        /* Responsive adjustments for mobile/PC compatibility */
        #chat-app {
            max-width: 100%;
            height: 100vh;
        }
        @media (min-width: 768px) {
            #chat-app {
                /* Set to 600px */
                max-width: 600px; 
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex justify-center items-center">

    <div id="chat-app" class="flex flex-col bg-primary-dark shadow-2xl rounded-lg overflow-hidden w-full h-full md:h-[90vh]">

        <div id="login-screen" class="flex flex-col items-center justify-center p-8 text-center flex-grow">
            <h1 class="text-3xl font-bold mb-4">Secure Chat</h1>
            <p class="mb-6 text-gray-400">Sign in to join the conversation.</p>
            
            <button id="google-sign-in-button" class="bg-google-red hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12.022 10.375c3.235 0 5.148 1.488 5.148 1.488s.098 3.55-5.148 3.55c-3.15 0-5.698-1.55-5.698-1.55l.022-.047c-.015-.027-.02-.045-.034-.067-1.1-2.073-1.12-4.135-1.12-4.135 0 0 2.275-3.328 6.702-3.328zm-6.273 4.25c.015.027.02.045.034.067 1.1 2.073 1.12 4.135 1.12 4.135 0 0-2.275 3.328-6.702 3.328-3.235 0-5.148-1.488-5.148-1.488s-.098-3.55 5.148-3.55c3.15 0 5.698 1.55 5.698 1.55l-.022.047zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-4.35 15.65C8.42 16.7 9.8 16 12 16s3.58.7 4.35 1.65c-1.28.66-2.73 1.05-4.35 1.05s-3.07-.39-4.35-1.05z"/>
                </svg>
                Sign in with Google
            </button>
            <div id="loading-indicator" class="mt-4 text-accent-blue hidden">
                Loading user data...
            </div>
        </div>

        <div id="chat-screen" class="hidden flex-col flex-grow">
            
            <header class="bg-secondary-dark p-4 shadow-xl flex justify-between items-center z-20 relative flex-shrink-0">
                <div class="flex items-center">
                    <button id="menu-button" class="text-gray-400 hover:text-white mr-4">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 id="chat-title" class="text-xl font-semibold">Public Chat</h2>
                </div>
                <div class="text-sm text-gray-400" id="user-email-display">Loading...</div>
            </header>

            <div id="side-menu" 
                class="fixed inset-0 z-30 bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none md:w-full">
                <div class="absolute inset-y-0 left-0 w-64 bg-primary-dark shadow-2xl p-6 transform -translate-x-full transition-transform duration-300 flex flex-col h-full">
                    <button id="close-menu-button" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                    <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">User Settings</h3>
                    
                    <p id="menu-user-email" class="text-sm text-gray-400 mb-4 break-all">Loading...</p>

                    <div class="mb-4">
                        <label for="username-input" class="block text-sm font-medium mb-1">Set Display Name (Max 8 chars):</label>
                        <div class="flex space-x-2">
                            <input type="text" id="username-input" maxlength="8" placeholder="Username" class="flex-grow bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:border-accent-blue">
                            <button id="save-username-button" class="bg-accent-green hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-200">Save</button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Contacts</h3>
                    <button id="switch-to-public-chat-button" class="w-full text-left p-3 rounded-lg bg-accent-blue hover:bg-blue-700 transition duration-150 mb-3 font-semibold">
                        Switch to Public Chat
                    </button>
                    <div id="contact-list" class="space-y-2 flex-grow overflow-y-auto mb-4">
                        </div>

                    <button id="clear-current-chat-button" class="bg-google-red hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm mb-4 transition duration-200">
                        Clear Chat History
                    </button>
                    
                    <button id="sign-out-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 mt-auto">
                        Sign Out
                    </button>
                </div>
            </div>

            <main id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 scroll-smooth"></main>

            <footer class="bg-secondary-dark p-4 shadow-2xl z-10 flex-shrink-0">
                <div class="flex space-x-2">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:border-accent-blue" disabled>
                    <button id="send-button" class="bg-accent-blue hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 transition duration-200" disabled>
                        Send
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        // ... (rest of the Firebase imports) ...
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, getDocs, deleteDoc, setDoc, doc, limit, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // =========================================================================
        // âœ… Your Firebase Configuration
        // =========================================================================
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAwfV2UkHnFJOET4yQpxXkCItP2FmTG2g8",
            authDomain: "dhee-chat-e14bc.firebaseapp.com",
            projectId: "dhee-chat-e14bc",
            storageBucket: "dhee-chat-e14bc.firebasestorage.app",
            messagingSenderId: "1091790414441",
            appId: "1:1091790414441:web:42bfa96e6b3eea8bdff8f8",
        };
        // =========================================================================
        
        // --- Configuration Logic ---
        let firebaseConfig;
        let appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        } else {
            firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId || 'chat-default-id';
        }
        
        // --- Global Firebase Instances and User State ---
        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserDisplayName = 'Anonymous'; 
        let currentChatType = 'public'; 
        let currentRecipient = null; 
        let unsubscribeMessages = null; 
        
        let notificationPermission = 'default';


        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const userEmailDisplay = document.getElementById('user-email-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const chatTitle = document.getElementById('chat-title');

        // --- Menu Elements ---
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuButton = document.getElementById('close-menu-button');
        const menuUserEmail = document.getElementById('menu-user-email');
        const contactList = document.getElementById('contact-list');
        const switchToPublicChatButton = document.getElementById('switch-to-public-chat-button');
        const clearCurrentChatButton = document.getElementById('clear-current-chat-button');
        // Username Elements
        const usernameInput = document.getElementById('username-input');
        const saveUsernameButton = document.getElementById('save-username-button');
        // -------------------------

        // --- Utility Functions ---

        async function fetchWithRetry(apiCall, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function switchView(showChat) {
            loginScreen.classList.toggle('hidden', showChat);
            chatScreen.classList.toggle('hidden', !showChat);
        }

        function getChatDisplay(userDoc) {
            if (!userDoc || (!userDoc.displayName && !userDoc.email)) return 'Anonymous';
            if (userDoc.displayName) {
                return userDoc.displayName; 
            }
            return userDoc.email ? userDoc.email.split('@')[0] : 'Anonymous';
        }

        // --- Menu Control Functions ---
        function openMenu() {
            sideMenu.classList.remove('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.remove('-translate-x-full'); 
        }

        function closeMenu() {
            sideMenu.classList.add('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.add('-translate-x-full');
        }

        function handleMenuClick(event) {
            if (event.target === sideMenu) {
                closeMenu();
            }
        }
        // -------------------------------------

        // --- Notifications ---
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission;
                    console.log("Notification permission:", permission);
                }).catch(error => {
                    console.error("Error requesting notification permission:", error);
                });
            }
        }

        // --- Authentication and User Setup Logic ---
        
        async function upsertUser(user) {
            if (!user.uid || !user.email) return;
            try {
                const userDocRef = doc(db, 'users', user.uid);
                
                await setDoc(userDocRef, {
                    userId: user.uid,
                    email: user.email,
                    lastSeen: Date.now()
                }, { merge: true });

                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();
                
                currentUserDisplayName = getChatDisplay(userData);
                usernameInput.value = userData?.displayName || '';
                
                userEmailDisplay.textContent = currentUserEmail || 'Signed In';
                menuUserEmail.textContent = `${currentUserDisplayName} (${currentUserEmail})` || 'Signed In'; 

            } catch (error) {
                console.error("Error upserting user data:", error);
            }
        }
        
        async function handleSetDisplayName() {
            const rawName = usernameInput.value.trim();
            const newName = rawName.substring(0, 8); 
            
            if (!newName || newName.length < 3) {
                alert("Username must be 3-8 characters long.");
                return;
            }
            if (!currentUserId) {
                alert("You must be logged in to set a username.");
                return;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUserId);
                await setDoc(userDocRef, {
                    displayName: newName,
                    lastSeen: Date.now() 
                }, { merge: true });
                
                currentUserDisplayName = newName;
                alert(`Username saved as: ${newName}`);
                
                menuUserEmail.textContent = `${currentUserDisplayName} (${currentUserEmail})` || 'Signed In'; 
                
                if(currentChatType === 'private' && currentRecipient) {
                    currentRecipient.displayName = newName;
                    switchToPrivateChat(currentRecipient);
                } else {
                    switchToPublicChat();
                }
                listenForContacts(); 
                
            } catch (error) {
                console.error("Error setting display name:", error);
                alert("Failed to save username. Check console for details.");
            }
        }

        
        function listenForContacts() {
            const usersRef = collection(db, 'users');
            onSnapshot(usersRef, (snapshot) => {
                contactList.innerHTML = '';
                snapshot.forEach(doc => {
                    const contact = doc.data();
                    if (contact.userId !== currentUserId) {
                        renderContact(contact);
                    }
                });
                
                if (contactList.children.length === 0) {
                    contactList.innerHTML = `<div class="text-sm text-gray-500 p-2 border border-gray-800 rounded-lg">
                        No other users found. Have another user log in!
                    </div>`;
                }
            }, (error) => {
                console.error("Error listening for contacts:", error);
            });
        }
        
        function renderContact(contact) {
            const contactDiv = document.createElement('div');
            const isSelected = currentRecipient && currentRecipient.userId === contact.userId;
            
            contactDiv.className = `p-3 rounded-lg cursor-pointer transition duration-150 break-all ${isSelected ? 'bg-accent-green bg-opacity-30 border border-accent-green' : 'bg-secondary-dark hover:bg-gray-700'}`;
            contactDiv.innerHTML = `<p class="text-sm font-semibold">${getChatDisplay(contact)}</p>`; 
            contactDiv.setAttribute('data-user-id', contact.userId);
            contactDiv.setAttribute('data-email', contact.email);
            contactDiv.setAttribute('data-display-name', contact.displayName || '');
            
            contactDiv.addEventListener('click', () => {
                const userId = contactDiv.getAttribute('data-user-id');
                const email = contactDiv.getAttribute('data-email');
                const displayName = contactDiv.getAttribute('data-display-name');
                
                switchToPrivateChat({ userId, email, displayName });
                closeMenu();
            });
            
            contactList.appendChild(contactDiv);
        }
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                userEmailDisplay.textContent = 'Login Error! Check console & domain settings.';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out failed:", error);
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                loadingIndicator.classList.add('hidden');
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;

                    await upsertUser(user); 
                    listenForContacts(); 
                    requestNotificationPermission();

                    switchView(true);

                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                    
                    switchToPublicChat(); 

                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserDisplayName = 'Anonymous';
                    if (unsubscribeMessages) {
                        unsubscribeMessages();
                        unsubscribeMessages = null;
                    } 
                    switchView(false);
                    chatMessagesContainer.innerHTML = '';
                    closeMenu();
                }
            });
        }


        // --- Chat Switching Logic ---
        
        function getPrivateChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        function switchToPublicChat() {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChatType = 'public';
            currentRecipient = null;
            chatTitle.textContent = 'Public Chat';
            clearCurrentChatButton.textContent = 'Clear Public Chat History';
            listenForMessages(); 
            listenForContacts(); 
        }
        
        function switchToPrivateChat(recipient) {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChatType = 'private';
            currentRecipient = recipient;
            
            chatTitle.textContent = `${getChatDisplay(recipient)}`; 
            clearCurrentChatButton.textContent = `Clear Chat with ${getChatDisplay(recipient)}`;
            listenForMessages(); 
            listenForContacts(); 
        }

        // --- Message Rendering and Firestore ---

        function renderMessage(message, isMe) {
            const messageDiv = document.createElement('div');
            
            let classes = ['flex', 'max-w-[80%]', 'md:max-w-md'];
            
            if (isMe) {
                classes.push('self-end', 'justify-end', 'ml-auto');
            } else {
                classes.push('self-start', 'justify-start', 'mr-auto');
            }

            messageDiv.className = classes.join(' ');

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl shadow-lg break-words transition duration-300 ${isMe 
                ? 'bg-accent-blue text-white rounded-br-none' 
                : 'bg-secondary-dark text-gray-100 rounded-tl-none'
            }`;
            
            const emailSpan = document.createElement('span');
            emailSpan.textContent = message.senderDisplayName || getChatDisplay(message) || 'Anonymous'; 
            emailSpan.className = `block text-xs font-bold mb-1 ${isMe ? 'text-blue-200' : 'text-accent-green'}`;
            bubble.appendChild(emailSpan);
            
            const textP = document.createElement('p');
            textP.textContent = message.text;
            textP.className = 'text-base';
            bubble.appendChild(textP);

            if (message.timestamp) {
                const date = new Date(message.timestamp);
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const timeSpan = document.createElement('span');
                timeSpan.textContent = time;
                timeSpan.className = `block mt-1 text-xs ${isMe ? 'text-blue-200 text-right' : 'text-gray-400 text-left'}`;
                bubble.appendChild(timeSpan);
            }

            messageDiv.appendChild(bubble);
            chatMessagesContainer.appendChild(messageDiv);
        }
        
        function listenForMessages() {
            let messagesCollectionPath;
            
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                chatMessagesContainer.innerHTML = '<div class="text-red-500 text-center p-4">Error: Invalid chat state.</div>';
                return;
            }
            
            const colRef = collection(db, messagesCollectionPath);
            
            const messagesQuery = query(colRef, orderBy('timestamp', 'asc'), limit(100));

            if (unsubscribeMessages) unsubscribeMessages(); 

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                
                // 1. Handle Notifications
                if (!document.hasFocus()) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            if (message.userId !== currentUserId) { 
                                if (notificationPermission === 'granted') {
                                    const title = currentChatType === 'public' ? 'New Public Message' : `New Private Message from ${message.senderDisplayName || getChatDisplay(message)}`;
                                    new Notification(title, {
                                        body: message.text,
                                    });
                                }
                            }
                        }
                    });
                }
                
                // 2. Render Messages
                const isNearBottom = chatMessagesContainer.scrollHeight - chatMessagesContainer.scrollTop <= chatMessagesContainer.clientHeight + 50;

                chatMessagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    renderMessage(message, message.userId === currentUserId);
                });
                
                if (isNearBottom) {
                    scrollToBottom();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                chatMessagesContainer.innerHTML = `<div class="text-red-500 text-center p-4">Error loading chat. Check console and security rules.</div>`;
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUserId || !currentUserEmail || !db) return;

            let messagesCollectionPath;
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                return;
            }

            try {
                await fetchWithRetry(async () => {
                    await addDoc(collection(db, messagesCollectionPath), {
                        userId: currentUserId,
                        email: currentUserEmail,
                        senderDisplayName: currentUserDisplayName, 
                        text: text,
                        timestamp: Date.now()
                    });
                });
                
                messageInput.value = '';
                messageInput.focus();
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        async function handleClearCurrentChat() {
            let chatName = currentChatType === 'public' ? 'Public Chat' : `Chat with ${getChatDisplay(currentRecipient)}`;
            
            if (!confirm(`Are you sure you want to permanently delete ALL messages from ${chatName}? This cannot be undone.`)) {
                return;
            }

            let messagesCollectionPath;
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                alert("Cannot clear chat: Invalid chat state.");
                return;
            }

            try {
                const colRef = collection(db, messagesCollectionPath);
                
                const snapshot = await getDocs(query(colRef, limit(500))); 
                
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                console.log(`Successfully deleted ${deletePromises.length} messages from ${chatName}.`);
                if (deletePromises.length >= 500) {
                     alert(`Cleared ${deletePromises.length} messages. A large chat may require running the clear operation again.`);
                } else {
                     alert(`${chatName} History Cleared!`);
                }
                
                closeMenu();

            } catch (error) {
                console.error("CRITICAL FIREBASE PERMISSION ERROR when clearing chat:", error);
                alert(`Failed to clear chat for ${chatName}. Please ENSURE your Firestore Security Rules are updated as instructed.`);
            }
        }


        // --- Initialization and Event Setup ---

        async function setupApp() {
            try {
                setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                loadingIndicator.classList.remove('hidden');

                if (initialAuthToken) {
                    await fetchWithRetry(async () => {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas environment: Signed in with custom token.");
                    });
                }
                
                setupAuthListener();
            } catch (error) {
                console.error("Fatal Error during app setup:", error);
                loadingIndicator.classList.add('hidden');
                userEmailDisplay.textContent = 'CRITICAL ERROR: Check Console';
            }
        }

        // --- Event Listeners ---
        googleSignInButton.addEventListener('click', handleGoogleSignIn);
        signOutButton.addEventListener('click', handleSignOut);
        sendButton.addEventListener('click', sendMessage);
        
        // Menu Listeners
        menuButton.addEventListener('click', openMenu);
        closeMenuButton.addEventListener('click', closeMenu);
        sideMenu.addEventListener('click', handleMenuClick);
        
        // Username Listener
        saveUsernameButton.addEventListener('click', handleSetDisplayName);
        usernameInput.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') {
                e.preventDefault();
                handleSetDisplayName();
             }
        });
        
        // Chat Switching/Clearing Listeners
        switchToPublicChatButton.addEventListener('click', () => {
            switchToPublicChat();
            closeMenu();
        });
        clearCurrentChatButton.addEventListener('click', handleClearCurrentChat);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize App on load
        window.onload = setupApp;

    </script>
</body>
</html>
