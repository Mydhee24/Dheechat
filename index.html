<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Multi-User Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-dark': '#111827', /* Darker background */
                        'secondary-dark': '#1f2937', /* Card/Input background */
                        'accent-blue': '#3b82f6',
                        'accent-green': '#10b981',
                        'google-red': '#db4437'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        .chat-container {
            /* Calculate height based on full screen minus header and footer/input area */
            height: calc(100vh - 8rem); 
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
            background-color: transparent;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        /* Responsive adjustments for mobile/PC compatibility */
        #chat-app {
            max-width: 100%;
            height: 100vh;
        }
        @media (min-width: 768px) {
            #chat-app {
                /* Set to 600px as requested earlier */
                max-width: 600px; 
                margin: 0 auto;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen flex justify-center items-center">

    <div id="chat-app" class="flex flex-col bg-primary-dark shadow-2xl rounded-lg overflow-hidden w-full h-full md:h-[90vh]">

        <div id="login-screen" class="flex flex-col items-center justify-center p-8 text-center flex-grow">
            <h2 class="text-4xl font-extrabold mb-4 text-accent-blue">Secure Chat Login</h2>
            <p class="text-gray-400 mb-8 max-w-sm">Sign in with your Google account to join the conversation.</p>
            <button id="google-sign-in-button" 
                    class="flex items-center justify-center bg-google-red hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl transform hover:scale-[1.03] active:scale-95">
                <svg class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.5-.2-2.2H12v4.16h5.88c-.26 1.42-1.04 2.68-2.3 3.53l-2.45 2.02v3.09h3.76c2.2-2.03 3.57-5.01 3.57-8.2zm-12.72 10.15c2.94 0 5.46-1.04 7.28-2.8l-3.76-3.09c-1.04.7-2.36 1.13-3.86 1.13-2.98 0-5.5-1.9-6.36-4.49H3.7v3.08c1.78 3.51 5.38 5.97 9.08 5.97zM4.3 9.4c-.16-.5-.25-1.03-.25-1.58s.09-1.08.25-1.58V3.24H.54c-.67 1.34-1.04 2.87-1.04 4.58s.37 3.24 1.04 4.58l3.76-3.08zM12 3.86c1.82 0 3.44.62 4.74 1.84l3.29-3.29C17.46.74 14.8.0 12.0.0c-3.7 0-7.3 2.46-9.08 5.97l3.76 3.08C6.5 5.76 9.02 3.86 12 3.86z"/>
                </svg>
                Sign in with Google
            </button>
        </div>

        <div id="chat-screen" class="hidden flex-col flex-grow">
            
            <header class="bg-secondary-dark p-4 shadow-xl flex justify-between items-center z-20 relative">
                <div class="flex items-center">
                    <button id="menu-button"
                            class="p-2 rounded-full hover:bg-gray-700 transition duration-200 focus:outline-none mr-3">
                        <svg class="w-6 h-6 text-gray-100" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 id="chat-title" class="text-xl font-bold text-accent-green truncate">
                        Public Chat
                    </h1>
                </div>
                
                <div class="flex items-center">
                    <span id="user-email-display" class="font-normal text-sm text-gray-400 mr-4 hidden md:block truncate max-w-xs"></span>
                    <button id="sign-out-button"
                            class="text-xs text-gray-400 hover:text-red-500 transition duration-200 p-2 rounded-lg">
                        Sign Out
                    </button>
                </div>
            </header>

            <div id="side-menu" 
                class="fixed inset-0 z-30 bg-black bg-opacity-70 transition-opacity duration-300 opacity-0 pointer-events-none md:w-full">
                
                <div class="absolute left-0 top-0 h-full w-64 bg-primary-dark shadow-2xl transform -translate-x-full transition-transform duration-300 flex flex-col">
                    <div class="p-4 bg-secondary-dark flex justify-between items-center border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-white">Menu & Contacts</h3>
                        <button id="close-menu-button" class="text-gray-400 hover:text-white p-1 rounded-full hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="p-4 border-b border-gray-700">
                        <p class="text-sm text-gray-400 mb-2">Logged in as:</p>
                        <p id="menu-user-email" class="text-white font-medium break-all"></p>
                        
                        <div class="mt-4">
                            <label for="username-input" class="block text-sm font-medium text-gray-400">Set Username (Max 8 Chars)</label>
                            <div class="flex mt-1">
                                <input type="text" id="username-input" maxlength="8" placeholder="e.g., dheeuser"
                                       class="flex-grow p-2 rounded-l-lg bg-primary-dark border border-gray-700 focus:outline-none focus:ring-1 focus:ring-accent-green text-white"
                                       autocomplete="off">
                                <button id="save-username-button"
                                        class="bg-accent-green text-white px-3 rounded-r-lg hover:bg-green-600 transition duration-200 font-semibold text-sm">
                                    Save
                                </button>
                            </div>
                        </div>

                        <button id="switch-to-public-chat-button"
                                class="mt-4 w-full text-center py-2 px-3 text-sm rounded-lg bg-accent-blue hover:bg-blue-600 transition duration-200 text-white font-semibold">
                            Switch to Public Chat
                        </button>

                        <button id="clear-current-chat-button"
                                class="mt-2 w-full text-center py-2 px-3 text-sm rounded-lg bg-google-red hover:bg-red-700 transition duration-200 text-white font-semibold">
                            Clear Current Chat History
                        </button>

                    </div>

                    <div class="p-4 flex-grow overflow-y-auto">
                        <h4 class="text-md font-semibold text-accent-green mb-3">Available Contacts</h4>
                        <div id="contact-list" class="space-y-2">
                            <div class="text-sm text-gray-500 p-2 border border-gray-800 rounded-lg" id="contact-loading">
                                Loading contacts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <main id="chat-messages" class="chat-container flex-grow p-4 space-y-4"></main>

            <footer class="bg-secondary-dark p-4 shadow-2xl z-10">
                <div id="loading-indicator" class="text-center text-accent-blue mb-2 hidden">
                    <div class="animate-spin inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full" role="status"></div>
                    Loading messages...
                </div>
                <div class="flex space-x-3 items-center">
                    
                    <input type="text" id="message-input" placeholder="Type your message..."
                           class="flex-grow p-3 rounded-xl bg-primary-dark border border-gray-700 focus:outline-none focus:ring-2 focus:ring-accent-blue text-gray-100 placeholder-gray-500 transition duration-300 shadow-inner"
                           autocomplete="off" maxlength="500" disabled>
                    <button id="send-button"
                            class="bg-accent-blue text-white font-semibold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-600 transition duration-300 transform hover:scale-[1.02] active:scale-95 disabled:bg-gray-600 disabled:shadow-none"
                            disabled>
                        Send
                    </button>
                </div>
            </footer>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel, getDocs, deleteDoc, setDoc, doc, limit, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // =========================================================================
        // âœ… Your Firebase Configuration
        // =========================================================================
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyAwfV2UkHnFJOET4yQpxXkCItP2FmTG2g8",
            authDomain: "dhee-chat-e14bc.firebaseapp.com",
            projectId: "dhee-chat-e14bc",
            storageBucket: "dhee-chat-e14bc.firebasestorage.app",
            messagingSenderId: "1091790414441",
            appId: "1:1091790414441:web:42bfa96e6b3eea8bdff8f8",
        };
        // =========================================================================
        
        // --- Configuration Logic ---
        let firebaseConfig;
        let appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        } else {
            firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
            appId = firebaseConfig.projectId || 'chat-default-id';
        }
        
        // --- Global Firebase Instances and User State ---
        let db;
        let auth;
        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserDisplayName = 'Anonymous'; // NEW: Stores the 8-char name
        let currentChatType = 'public'; // 'public' or 'private'
        let currentRecipient = null; // { userId, email, displayName } for private chat
        let unsubscribeMessages = null; // Function to stop the message listener
        
        // Global state for notifications
        let notificationPermission = 'default';


        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const chatScreen = document.getElementById('chat-screen');
        const googleSignInButton = document.getElementById('google-sign-in-button');
        const signOutButton = document.getElementById('sign-out-button');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const userEmailDisplay = document.getElementById('user-email-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const chatTitle = document.getElementById('chat-title');

        // --- Menu Elements ---
        const menuButton = document.getElementById('menu-button');
        const sideMenu = document.getElementById('side-menu');
        const closeMenuButton = document.getElementById('close-menu-button');
        const menuUserEmail = document.getElementById('menu-user-email');
        const contactList = document.getElementById('contact-list');
        const switchToPublicChatButton = document.getElementById('switch-to-public-chat-button');
        const clearCurrentChatButton = document.getElementById('clear-current-chat-button');
        // NEW Username Elements
        const usernameInput = document.getElementById('username-input');
        const saveUsernameButton = document.getElementById('save-username-button');
        // -------------------------

        // --- Utility Functions ---

        async function fetchWithRetry(apiCall, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function scrollToBottom() {
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function switchView(showChat) {
            loginScreen.classList.toggle('hidden', showChat);
            chatScreen.classList.toggle('hidden', !showChat);
        }

        // NEW: Extracts the name for display (Priority: 1. Saved Name, 2. Short Email)
        function getChatDisplay(userDoc) {
            if (!userDoc || (!userDoc.displayName && !userDoc.email)) return 'Anonymous';
            // Prioritize the user-set displayName if it exists
            if (userDoc.displayName) {
                return userDoc.displayName; 
            }
            // Otherwise, fall back to the part of the email before the @
            return userDoc.email ? userDoc.email.split('@')[0] : 'Anonymous';
        }

        // --- Menu Control Functions ---
        function openMenu() {
            sideMenu.classList.remove('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.remove('-translate-x-full'); 
        }

        function closeMenu() {
            sideMenu.classList.add('opacity-0', 'pointer-events-none');
            sideMenu.querySelector('div').classList.add('-translate-x-full');
        }

        function handleMenuClick(event) {
            if (event.target === sideMenu) {
                closeMenu();
            }
        }
        // -------------------------------------

        // --- Notifications ---
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    notificationPermission = permission;
                    console.log("Notification permission:", permission);
                }).catch(error => {
                    console.error("Error requesting notification permission:", error);
                });
            }
        }

        // --- Authentication and User Setup Logic ---
        
        async function upsertUser(user) {
            if (!user.uid || !user.email) return;
            try {
                const userDocRef = doc(db, 'users', user.uid);
                
                // 1. Write/Merge basic user data
                await setDoc(userDocRef, {
                    userId: user.uid,
                    email: user.email,
                    lastSeen: Date.now()
                }, { merge: true });

                // 2. Read back to get saved display name
                const userDoc = await getDoc(userDocRef);
                const userData = userDoc.data();
                
                // 3. Update global state and UI elements
                currentUserDisplayName = getChatDisplay(userData);
                usernameInput.value = userData?.displayName || '';
                
                userEmailDisplay.textContent = currentUserEmail || 'Signed In';
                menuUserEmail.textContent = `${currentUserDisplayName} (${currentUserEmail})` || 'Signed In'; 

            } catch (error) {
                console.error("Error upserting user data:", error);
            }
        }
        
        async function handleSetDisplayName() {
            const newName = usernameInput.value.trim().substring(0, 8); // Ensure max 8 chars
            
            if (!newName || newName.length < 3) {
                alert("Username must be 3-8 characters long.");
                return;
            }
            if (!currentUserId) {
                alert("You must be logged in to set a username.");
                return;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUserId);
                await setDoc(userDocRef, {
                    displayName: newName,
                    lastSeen: Date.now() 
                }, { merge: true });
                
                currentUserDisplayName = newName;
                alert(`Username saved as: ${newName}`);
                
                // Refresh UI elements
                menuUserEmail.textContent = `${currentUserDisplayName} (${currentUserEmail})` || 'Signed In'; 
                
                // Re-render contact list and current chat title to use the new name
                if(currentChatType === 'private' && currentRecipient) {
                    // Update currentRecipient object with the new display name
                    currentRecipient.displayName = newName;
                    switchToPrivateChat(currentRecipient);
                } else {
                    switchToPublicChat();
                }
                listenForContacts(); 
                
            } catch (error) {
                console.error("Error setting display name:", error);
                alert("Failed to save username. Check console for details.");
            }
        }

        
        function listenForContacts() {
            const usersRef = collection(db, 'users');
            // Listen for changes and update the contact list
            onSnapshot(usersRef, (snapshot) => {
                contactList.innerHTML = '';
                snapshot.forEach(doc => {
                    const contact = doc.data();
                    if (contact.userId !== currentUserId) {
                        renderContact(contact);
                    }
                });
                
                if (contactList.children.length === 0) {
                    contactList.innerHTML = `<div class="text-sm text-gray-500 p-2 border border-gray-800 rounded-lg">
                        No other users found. Have another user log in!
                    </div>`;
                }
            }, (error) => {
                console.error("Error listening for contacts:", error);
            });
        }
        
        function renderContact(contact) {
            const contactDiv = document.createElement('div');
            const isSelected = currentRecipient && currentRecipient.userId === contact.userId;
            
            contactDiv.className = `p-3 rounded-lg cursor-pointer transition duration-150 break-all ${isSelected ? 'bg-accent-green bg-opacity-30 border border-accent-green' : 'bg-secondary-dark hover:bg-gray-700'}`;
            // Use display name for the contact list
            contactDiv.innerHTML = `<p class="text-sm font-semibold">${getChatDisplay(contact)}</p>`; 
            contactDiv.setAttribute('data-user-id', contact.userId);
            contactDiv.setAttribute('data-email', contact.email);
            contactDiv.setAttribute('data-display-name', contact.displayName || '');
            
            contactDiv.addEventListener('click', () => {
                const userId = contactDiv.getAttribute('data-user-id');
                const email = contactDiv.getAttribute('data-email');
                const displayName = contactDiv.getAttribute('data-display-name');
                
                switchToPrivateChat({ userId, email, displayName });
                closeMenu();
            });
            
            contactList.appendChild(contactDiv);
        }
        
        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                userEmailDisplay.textContent = 'Login Error! Check console & domain settings.';
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out failed:", error);
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                loadingIndicator.classList.add('hidden');
                if (user) {
                    currentUserId = user.uid;
                    currentUserEmail = user.email;

                    await upsertUser(user); // Fetch/set display name
                    listenForContacts(); 
                    requestNotificationPermission();

                    switchView(true);

                    sendButton.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                    
                    switchToPublicChat(); 

                } else {
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserDisplayName = 'Anonymous';
                    if (unsubscribeMessages) {
                        unsubscribeMessages();
                        unsubscribeMessages = null;
                    } 
                    switchView(false);
                    chatMessagesContainer.innerHTML = '';
                    closeMenu();
                }
            });
        }


        // --- Chat Switching Logic ---
        
        function getPrivateChatId(userId1, userId2) {
            return [userId1, userId2].sort().join('_');
        }

        function switchToPublicChat() {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChatType = 'public';
            currentRecipient = null;
            chatTitle.textContent = 'Public Chat';
            clearCurrentChatButton.textContent = 'Clear Public Chat History';
            listenForMessages(); 
            listenForContacts(); 
        }
        
        function switchToPrivateChat(recipient) {
            if (unsubscribeMessages) unsubscribeMessages();
            currentChatType = 'private';
            currentRecipient = recipient;
            
            // CRITICAL UPDATE: Only show the recipient's display name
            chatTitle.textContent = `${getChatDisplay(recipient)}`; 
            clearCurrentChatButton.textContent = `Clear Chat with ${getChatDisplay(recipient)}`;
            listenForMessages(); 
            listenForContacts(); 
        }

        // --- Message Rendering and Firestore ---

        function renderMessage(message, isMe) {
            const messageDiv = document.createElement('div');
            
            let classes = ['flex', 'max-w-[80%]', 'md:max-w-md'];
            
            if (isMe) {
                classes.push('self-end', 'justify-end', 'ml-auto');
            } else {
                classes.push('self-start', 'justify-start', 'mr-auto');
            }

            messageDiv.className = classes.join(' ');

            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl shadow-lg break-words transition duration-300 ${isMe 
                ? 'bg-accent-blue text-white rounded-br-none' 
                : 'bg-secondary-dark text-gray-100 rounded-tl-none'
            }`;
            
            // Username/Email - Use the saved senderDisplayName from the message
            const emailSpan = document.createElement('span');
            emailSpan.textContent = message.senderDisplayName || getChatDisplay(message) || 'Anonymous'; 
            emailSpan.className = `block text-xs font-bold mb-1 ${isMe ? 'text-blue-200' : 'text-accent-green'}`;
            bubble.appendChild(emailSpan);
            
            // Message Text
            const textP = document.createElement('p');
            textP.textContent = message.text;
            textP.className = 'text-base';
            bubble.appendChild(textP);

            // Timestamp
            if (message.timestamp) {
                const date = new Date(message.timestamp);
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const timeSpan = document.createElement('span');
                timeSpan.textContent = time;
                timeSpan.className = `block mt-1 text-xs ${isMe ? 'text-blue-200 text-right' : 'text-gray-400 text-left'}`;
                bubble.appendChild(timeSpan);
            }

            messageDiv.appendChild(bubble);
            chatMessagesContainer.appendChild(messageDiv);
        }
        
        function listenForMessages() {
            let messagesCollectionPath;
            
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
                
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                chatMessagesContainer.innerHTML = '<div class="text-red-500 text-center p-4">Error: Invalid chat state.</div>';
                return;
            }
            
            const colRef = collection(db, messagesCollectionPath);
            
            const messagesQuery = query(colRef, orderBy('timestamp', 'asc'), limit(100));

            if (unsubscribeMessages) unsubscribeMessages(); // Ensure previous listener is stopped

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                
                // 1. Handle Notifications
                if (!document.hasFocus()) {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            // Only notify for new messages not sent by me
                            if (message.userId !== currentUserId) { 
                                if (notificationPermission === 'granted') {
                                    const title = currentChatType === 'public' ? 'New Public Message' : `New Private Message from ${message.senderDisplayName || getChatDisplay(message)}`;
                                    new Notification(title, {
                                        body: message.text,
                                    });
                                }
                            }
                        }
                    });
                }
                
                // 2. Render Messages
                const shouldScroll = chatMessagesContainer.scrollHeight - chatMessagesContainer.scrollTop <= chatMessagesContainer.clientHeight + 50;

                chatMessagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const message = doc.data();
                    renderMessage(message, message.userId === currentUserId);
                });
                
                if (shouldScroll) {
                    scrollToBottom();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                chatMessagesContainer.innerHTML = `<div class="text-red-500 text-center p-4">Error loading chat. Check console and security rules.</div>`;
            });
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentUserId || !currentUserEmail || !db) return;

            let messagesCollectionPath;
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                return;
            }

            try {
                await fetchWithRetry(async () => {
                    await addDoc(collection(db, messagesCollectionPath), {
                        userId: currentUserId,
                        email: currentUserEmail,
                        senderDisplayName: currentUserDisplayName, // NEW: Save the 8-char name with the message
                        text: text,
                        timestamp: Date.now()
                    });
                });
                
                messageInput.value = '';
                messageInput.focus();
            } catch (error) {
                console.error("Error sending message:", error);
            }
        }

        async function handleClearCurrentChat() {
            let chatName = currentChatType === 'public' ? 'Public Chat' : `Chat with ${getChatDisplay(currentRecipient)}`;
            
            if (!confirm(`Are you sure you want to permanently delete ALL messages from ${chatName}? This cannot be undone.`)) {
                return;
            }

            let messagesCollectionPath;
            if (currentChatType === 'public') {
                messagesCollectionPath = `artifacts/${appId}/public/data/messages`;
            } else if (currentChatType === 'private' && currentRecipient) {
                const chatId = getPrivateChatId(currentUserId, currentRecipient.userId);
                messagesCollectionPath = `private_chats/${chatId}/messages`;
            } else {
                alert("Cannot clear chat: Invalid chat state.");
                return;
            }

            try {
                const colRef = collection(db, messagesCollectionPath);
                
                // Fetch up to 500 documents for deletion to manage batch size
                const snapshot = await getDocs(query(colRef, limit(500))); 
                
                if (snapshot.empty) {
                    alert(`${chatName} is already empty.`);
                    closeMenu();
                    return;
                }
                
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                console.log(`Successfully deleted ${deletePromises.length} messages from ${chatName}.`);
                if (deletePromises.length >= 500) {
                     alert(`Cleared ${deletePromises.length} messages. A large chat may require running the clear operation again.`);
                } else {
                     alert(`${chatName} History Cleared!`);
                }
                
                closeMenu();

            } catch (error) {
                console.error("CRITICAL FIREBASE PERMISSION ERROR when clearing chat:", error);
                alert(`Failed to clear chat for ${chatName}. Please ENSURE your Firestore Security Rules are updated as instructed.`);
            }
        }


        // --- Initialization and Event Setup ---

        async function setupApp() {
            try {
                setLogLevel('Debug');
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                loadingIndicator.classList.remove('hidden');

                if (initialAuthToken) {
                    await fetchWithRetry(async () => {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Canvas environment: Signed in with custom token.");
                    });
                }
                
                setupAuthListener();
            } catch (error) {
                console.error("Fatal Error during app setup:", error);
                loadingIndicator.classList.add('hidden');
                userEmailDisplay.textContent = 'CRITICAL ERROR: Check Console';
            }
        }

        // --- Event Listeners ---
        googleSignInButton.addEventListener('click', handleGoogleSignIn);
        signOutButton.addEventListener('click', handleSignOut);
        sendButton.addEventListener('click', sendMessage);
        
        // Menu Listeners
        menuButton.addEventListener('click', openMenu);
        closeMenuButton.addEventListener('click', closeMenu);
        sideMenu.addEventListener('click', handleMenuClick);
        
        // NEW Username Listener
        saveUsernameButton.addEventListener('click', handleSetDisplayName);
        usernameInput.addEventListener('keydown', (e) => {
             if (e.key === 'Enter') {
                e.preventDefault();
                handleSetDisplayName();
             }
        });
        
        // Chat Switching/Clearing Listeners
        switchToPublicChatButton.addEventListener('click', () => {
            switchToPublicChat();
            closeMenu();
        });
        clearCurrentChatButton.addEventListener('click', handleClearCurrentChat);

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !sendButton.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize App on load
        window.onload = setupApp;

    </script>
</body>
</html>
